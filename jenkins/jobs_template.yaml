#########################################################################################
# Test and build all platform
#########################################################################################

- job:
    block-downstream: false
    block-upstream: false
    builders:
    - shell: VERSION=${version} TESTS=${process_tests} /home/geomop/docker/jenkins.sh
    concurrent: false
    description: null
    disabled: false
    name: 'gm-build'
    display-name: "GeoMop Build"
    parameters:
    - string:
        default: master
        description: Select git branch.
        name: branch
    - string:
        default: ''
        description: Specify version string.
        name: version
    - bool:
        default: true
        description: Test GeoMop application before installation building.
        name: process_tests
    project-type: freestyle
    publishers:
    - archive:
        artifacts: 'dist/*.deb, dist/*.exe'
        allow-empty: false
        only-if-success: false
        fingerprint: true
        default-excludes: false
        case-sensitive: true
    scm:
    - git:
        branches:
        - refs/heads/${branch}
        url: https://github.com/GeoMop/GeoMop
    triggers: []
    wrappers: []

#########################################################################################
# Test after commit
#########################################################################################
- job-template:
    name: "test-{module}"
    display-name: "Test {module} module"
    builders:
      - shell: cd /var/lib/jenkins/workspace/gm-linux-tests/testing;python3 {test-file}

- project:
    name: "test-{module}"
    module: 
        - common:
            test-file: runCm.py
        - me:
            test-file: runMe.py
        - jp:
            test-file: runJp.py
        - an:
            test-file: runAn.py
    jobs:
        - "test-{module}"
 

- job:
    name: "gm-linux-tests"
    display-name: "GeoMop Linux Tests"
    parameters:
    - string:
        default: master
        description: Select git branch.
        name: branch
    scm:
    - git:
        branches:
        - refs/heads/${branch}
        url: https://github.com/GeoMop/GeoMop
    project-type: multijob
    builders:
      - multijob:
          condition: COMPLETED
          name: 'Unit tests'
          projects:
            - name: test-common
            - name: test-me
            - name: test-jp
            - name: test-an

